<!DOCTYPE html>
<html>
  <head>
    <title>Timer Selector</title>

    <meta charset="UTF-8">
    <meta name="description" content="SCP Wiki Timer Selector">
    <meta name="keywords" content="scp,wiki,timer,selector,generator">

    <style>
      /* TODO */

      /* Basic utility classes */
      .hidden {
        display: none;
      }

      #error {
        text-align: center;
        color: #b01;
      }

      .error-secondary {
        font-size: 0.6em;
      }
    </style>
  </head>

  <body>
    <noscript>This application requires Javascript to function.</noscript>

    <h1 id="error" class="hidden"></h1>

    <div id="timer-type">
    </div>

    <div id="timer-text">
    </div>

    <fieldset id="start">
      <legend id="start-label"></legend>

      <!-- now -->
      <input type="radio" name="start" value="now">
      <label id="start-now" for="now"></label>

      <!-- later / other time -->
      <input type="radio" name="start" value="other">
      <label id="start-other" for="other"></label>
    </fieldset>

    <fieldset id="duration">
      <legend id="duration-label"></legend>

      <!-- 1 hour -->
      <input type="radio" name="duration" value="3600000">
      <label id="duration-1h" for="3600000"></label>

      <!-- 1 day -->
      <input type="radio" name="duration" value="86400000">
      <label id="duration-1d" for="86400000"></label>

      <!-- 2 days -->
      <input type="radio" name="duration" value="172800000">
      <label id="duration-2d" for="172800000"></label>

      <!-- 1 week -->
      <input type="radio" name="duration" value="604800000">
      <label id="duration-1w" for="604800000"></label>

      <!-- 2 weeks -->
      <input type="radio" name="duration" value="1209600000">
      <label id="duration-2w" for="1209600000"></label>

      <!-- 1 year -->
      <input type="radio" name="duration" value="31536000000">
      <label id="duration-1y" for="31536000000"></label>
    </fieldset>

    <script>
      // Errors are only in English unfortunately
      function setError(primary, secondary = null) {
        var errorElement = document.getElementById('error');
        errorElement.classList.remove('hidden');
        errorElement.innerText = primary;

        if (secondary) {
          var secondaryErrorElement = document.createElement('div');
          secondaryErrorElement.classList = ['error-secondary'];
          secondaryErrorElement.innerText = secondary;
          errorElement.appendChild(secondaryErrorElement);
        }
      }

      // Localization
      function getMessage(language, messageKey) {
        var translations = {
          // English
          'en': {
            'duration': 'Duration',
            'duration-1h': '1 Hour',
            'duration-1d': '1 Day',
            'duration-2d': '2 Days',
            'duration-1w': '1 Week',
            'duration-2w': '2 Weeks',
            'duration-1y': '1 Year',
            'start-time': 'Start time',
            'start-time-now': 'Now',
            'start-time-other': 'Other',
            // TODO
          },

          // Pig Latin
          'pig': {
            'duration': 'Urationday',
            // TODO
          },
        };

        var messages = translations[language];
        if (!messages) {
          setError('No translations for language: ' + language);
          return null;
        }

        var message = messages[messageKey];
        if (!message) {
          setError('No such message key: ' + messageKey);
          return null;
        }

        return message;
      }

      function insertCSS(styling) {
        var head = document.head || document.getElementsByTagName('head')[0];
        var style = document.createElement('style');

        style.type = 'text/css';
        style.appendChild(document.createTextNode(styling));
        head.appendChild(style);
      }

      // Timer creation
      function buildUrl(language, startDate, durationMs, progressMessage, finishedMessage, styling) {
        // Calculate target datetime
        var targetTimestamp = (startDate || new Date()) + durationMs;
        var targetDate = new Date(targetTimestamp);

        // Finally, build URL
        var parameters = new URLSearchParams();
        parameters.append('lang', language);
        parameters.append('time', targetDate.toISOString());

        if (progressMessage) {
          parameters.append('progress', progressMessage);
        }

        if (finishedMessage) {
          parameters.append('finished', finishedMessage);
        }

        if (styling) {
          parameters.append('style', styling);
        }

        return 'https://scpwiki.github.io/timer/timer.html?' + parameters;
      }

      function buildWikitext(url, height = '250px', width = '500px') {
        return [
          '[[iframe ', url, ' style="width: ', width, '; height: ', height, '; border: 0;"]]',
        ].join('');
      }

      function initializeMessages(language) {
        function setMessage(id, messageKey = null) {
          document.getElementById(id).innerText = getMessage(language, messageKey || id);
        }

        setMessage('start-label', 'start-time');
        setMessage('start-now', 'start-time-now');
        setMessage('start-other', 'start-time-other');

        setMessage('duration-label', 'duration');
        setMessage('duration-1h');
        setMessage('duration-1d');
        setMessage('duration-2d');
        setMessage('duration-1w');
        setMessage('duration-2w');
        setMessage('duration-1y');
      }

      function setup() {
        // Get parameters
        var url = new URL(window.location.href);
        var parameters = new URLSearchParams(url.search);
        var language = parameters.get('lang');
        var styling = parameters.get('style');

        // Check parameters
        if (!language) {
          setError('No language set', 'Parameter is "lang". Use "en" for English.');
          return;
        }

        // Insert custom CSS, if any
        if (styling !== null) {
          insertCSS(style);
        }

        initializeMessages(language);
      }

      setup();
    </script>
  </body>
</html>
