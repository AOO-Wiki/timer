<!DOCTYPE html>
<html>
  <head>
    <title>Timer Selector</title>

    <meta charset="UTF-8">
    <meta name="description" content="SCP Wiki Timer Selector">
    <meta name="keywords" content="scp,wiki,timer,selector,generator">

    <style>
      /* Main elements */
      body {
        font-family: Arial, sans-serif;
      }

      fieldset {
        margin: 0.2em;
      }

      input[type=text],
      input[type=number] {
        margin-left: 0.2em;
      }

      #build {
        margin: 0.4em;
      }

      /* Basic utility classes */
      .hidden {
        display: none;
      }

      #error {
        text-align: center;
        color: #b01;
      }

      .error-secondary {
        font-size: 0.6em;
      }

      #output {
        font-family: 'Droid Sans Mono', 'DejaVu Sans Mono', monospace;
        margin: 0.25em;
      }
    </style>
  </head>

  <body>
    <noscript>This application requires Javascript to function.</noscript>

    <h1 id="error" class="hidden"></h1>

    <fieldset id="timer-type">
      <legend id="timer-type-label"></legend>

      <!-- Generic -->
      <input id="timer-type-generic" type="radio" name="timer-type" value="generic" checked>
      <label id="timer-type-generic-label" for="timer-type"></label>

      <!-- Deletion -->
      <input id="timer-type-deletion" type="radio" name="timer-type" value="deletion">
      <label id="timer-type-deletion-label" for="timer-type"></label>

      <!-- Ban -->
      <input id="timer-type-ban" type="radio" name="timer-type" value="ban">
      <label id="timer-type-ban-label" for="timer-type"></label>
    </fieldset>

    <div id="timer-text">
    </div>

    <fieldset id="start">
      <legend id="start-label"></legend>

      <!-- now -->
      <input id="start-now" type="radio" name="start" value="now" checked>
      <label id="start-now-label" for="now"></label>

      <!-- later / other time -->
      <input id="start-later" type="radio" name="start" value="later">
      <label id="start-later-label" for="later"></label>
      <input id="start-later-value" type="text" size="10"></input>
    </fieldset>

    <fieldset id="duration">
      <legend id="duration-label"></legend>

      <!-- 1 day -->
      <input id="duration-1d" type="radio" name="duration" value="86400000" checked>
      <label id="duration-1d-label" for="86400000"></label>

      <!-- 1 week -->
      <input id="duration-1w" type="radio" name="duration" value="604800000">
      <label id="duration-1w-label" for="604800000"></label>

      <!-- 2 weeks -->
      <input id="duration-2w" type="radio" name="duration" value="1209600000">
      <label id="duration-2w-label" for="1209600000"></label>

      <!-- 4 weeks -->
      <input id="duration-4w" type="radio" name="duration" value="2419200000">
      <label id="duration-4w-label" for="2419200000"></label>

      <!-- 1 year -->
      <input id="duration-1y" type="radio" name="duration" value="31536000000">
      <label id="duration-1y-label" for="31536000000"></label>

      <!-- custom -->
      <input id="duration-custom" type="radio" name="duration" value="custom">
      <label id="duration-custom-label" for="custom"></label>
      <input id="duration-custom-value" type="number" size="6"></input>
      <select id="duration-custom-unit">
        <option id="unit-minute" value="60"></option>
        <option id="unit-hour" value="3600"></option>
        <option id="unit-day" value="86400"></option>
        <option id="unit-week" value="604800"></option>
        <option id="unit-month" value="2592000"></option>
        <option id="unit-year" value="31536000"></option>
      </select>
    </fieldset>

    <fieldset id="messages">
      <div>
        <label id="message-progress-label"></label>
        <input id="message-progress" type="text"></input>
      </div>

      <div>
        <label id="message-finished-label"></label>
        <input id="message-finished" type="text"></input>
      </div>
    </fieldset>

    <fieldset id="misc">
    </fieldset>

    <!-- output -->
    <button id="build"></button>

    <div><textarea id="output" class="hidden" cols="60" rows="4" readonly></textarea></div>

    <script>
      // Constants
      var SECONDS_MS = 1000;
      var MINUTES_MS = SECONDS_MS * 60;
      var HOURS_MS = MINUTES_MS * 60;
      var DAYS_MS = HOURS_MS * 24;

      // Errors are only in English unfortunately
      function setError(primary, secondary = null) {
        var errorElement = document.getElementById('error');
        errorElement.classList.remove('hidden');
        errorElement.innerText = primary;

        if (secondary) {
          var secondaryErrorElement = document.createElement('div');
          secondaryErrorElement.classList = ['error-secondary'];
          secondaryErrorElement.innerText = secondary;
          errorElement.appendChild(secondaryErrorElement);
        }
      }

      // Localization
      function getMessage(language, messageKey) {
        var translations = {
          // English
          'en': {
            'timer-description': 'Timer expiring at',
            'timer-progress': 'This timer will expire in',
            'timer-finished': 'This timer has been expired since',
            'timer-type': 'Timer Type',
            'timer-type-generic': 'Generic',
            'timer-type-deletion': 'Deletion',
            'timer-type-ban': 'Ban',
            'duration': 'Duration',
            'duration-1d': '1 Day',
            'duration-1w': '1 Week',
            'duration-2w': '2 Weeks',
            'duration-4w': '4 Weeks',
            'duration-1y': '1 Year',
            'duration-custom': 'Custom',
            'unit-minute': 'minutes',
            'unit-hour': 'hours',
            'unit-day': 'days',
            'unit-week': 'weeks',
            'unit-month': 'months',
            'unit-year': 'years',
            'start-time': 'Start Time',
            'start-time-now': 'Now',
            'start-time-later': 'Later',
            'message-progress': 'Progress message (optional)',
            'message-finished': 'Finished message (optional)',
            'build-timer': 'Build timer',
            'error-missing': 'Please make a selection in each section first.',
            'error-invalid': 'Invalid internal state, please file a bug report.',
          },

          // Pig Latin
          'pig': {
            'duration': 'Urationday',
            // TODO
          },
        };

        var messages = translations[language];
        if (!messages) {
          setError('No translations for language: ' + language);
          return null;
        }

        var message = messages[messageKey];
        if (!message) {
          setError('No such message key: ' + messageKey);
          return null;
        }

        return message;
      }

      function insertCSS(styling) {
        var head = document.head || document.getElementsByTagName('head')[0];
        var style = document.createElement('style');

        style.type = 'text/css';
        style.appendChild(document.createTextNode(styling));
        head.appendChild(style);
      }

      // Timer creation
      function buildUrl(language, startTimestamp, durationMs, progressMessage, finishedMessage, styling) {
        // Calculate target datetime
        var targetDate = new Date(startTimestamp + durationMs);

        // Finally, build URL
        var parameters = new URLSearchParams();
        parameters.append('lang', language);
        parameters.append('time', targetDate.toISOString());

        if (progressMessage) {
          parameters.append('progress', progressMessage);
        }

        if (finishedMessage) {
          parameters.append('finished', finishedMessage);
        }

        if (styling) {
          parameters.append('style', styling);
        }

        return 'https://scpwiki.github.io/timer/timer.html?' + parameters;
      }

      function buildWikitext(url, height = '250px', width = '500px') {
        return [
          '[[iframe ', url, ' style="width: ', width, '; height: ', height, '; border: 0;"]]',
        ].join('');
      }

      function getStartTimestamp(language) {
        var element = document.querySelector('#start input[checked]');
        if (element === null) {
          alert(getMessage(language, 'error-missing'));
          throw new Error('Missing element in getStartTimestamp()');
        }

        switch (element.id) {
          case 'start-now':
            return new Date().getTime();
          case 'start-later':
            element = document.getElementById('start-later-value');
            return parseFloat(element.value);
          default:
            alert(getMessage(language, 'error-invalid'));
            throw new Error('Invalid element ID in getStartDate()');
        }
      }

      function getDuration() {
        var element = document.querySelector('#duration input[checked]');
        if (element === null) {
          alert(getMessage(language, 'error-missing'));
          throw new Error('Missing element in getDuration()');
        }

        if (element.value !== 'custom') {
          return parseInt(element.value);
        }

        var valueElement = document.getElementById('duration-custom-value');
        var value = parseInt(valueElement.value);

        var unitElement = document.getElementById('duration-custom-unit');
        var unit = parseInt(unitElement.value);

        return value * unit;
      }

      function buildTimer(language) {
        // Unhide output
        var outputElement = document.getElementById('output');
        outputElement.classList.remove('hidden');

        // Gather values
        var startTimestamp = getStartTimestamp(language);
        var durationMs = getDuration(language);
        var progressMessage = null;
        var finishedMessage = null;
        var styling = null;

        // Build wikitext and output
        var url = buildUrl(
          language,
          startTimestamp,
          durationMs,
          progressMessage,
          finishedMessage,
          styling,
        );

        outputElement.innerText = buildWikitext(url);
      }

      // Initialization
      function initializeMessages(language) {
        function setMessage(id, messageKey = null) {
          document.getElementById(id).innerText = getMessage(language, messageKey || id);
        }

        var element;

        setMessage('timer-type-label', 'timer-type');
        setMessage('timer-type-generic-label', 'timer-type-generic');
        setMessage('timer-type-deletion-label', 'timer-type-deletion');
        setMessage('timer-type-ban-label', 'timer-type-ban');

        setMessage('start-label', 'start-time');
        setMessage('start-now-label', 'start-time-now');
        setMessage('start-later-label', 'start-time-later');

        setMessage('duration-label', 'duration');
        setMessage('duration-1d-label', 'duration-1d');
        setMessage('duration-1w-label', 'duration-1w');
        setMessage('duration-2w-label', 'duration-2w');
        setMessage('duration-4w-label', 'duration-4w');
        setMessage('duration-1y-label', 'duration-1y');
        setMessage('duration-custom-label', 'duration-custom');

        setMessage('unit-minute');
        setMessage('unit-hour');
        setMessage('unit-day');
        setMessage('unit-week');
        setMessage('unit-month');
        setMessage('unit-year');

        document.getElementById('message-progress').placeholder = getMessage(language, 'timer-progress');
        document.getElementById('message-finished').placeholder = getMessage(language, 'timer-finished');
        setMessage('message-progress-label', 'message-progress');
        setMessage('message-finished-label', 'message-finished');

        setMessage('build', 'build-timer');

        // Set initial "later" date, as an example. Current date plus six months.
        var now = new Date().getTime();
        var later = new Date(now + 6 * 30 * DAYS_MS);
        var month = String(later.getMonth() + 1).padStart(2, '0');
        var day = String(later.getDay() + 1).padStart(2, '0');
        var dateValue = later.getFullYear() + '-' + month + '-' + day;
        document.getElementById('start-later-value').value = dateValue;
      }

      function initializeHooks(language) {
        document.getElementById('timer-type-deletion').onclick = function () {
          document.getElementById('duration-1d').click();
        };

        document.getElementById('timer-type-ban').onclick = function () {
          document.getElementById('duration-4w').click();
        };

        document.getElementById('build').onclick = function () {
          buildTimer(language);
        };
      }

      function setup() {
        // Get parameters
        var url = new URL(window.location.href);
        var parameters = new URLSearchParams(url.search);
        var language = parameters.get('lang');
        var styling = parameters.get('style');

        // Check parameters
        if (!language) {
          setError('No language set', 'Parameter is "lang". Use "en" for English.');
          return;
        }

        // Insert custom CSS, if any
        if (styling !== null) {
          insertCSS(style);
        }

        initializeMessages(language);
        initializeHooks(language);
      }

      setup();
    </script>
  </body>
</html>
